<UserControl x:Class="TimeStudiesWpf.Views.DefinitionEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:TimeStudiesWpf.Views"
             xmlns:models="clr-namespace:TimeStudiesWpf.Models"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="800">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Definition Header -->
        <GroupBox Grid.Row="0" Header="Time Study Definition" Margin="4" Padding="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:" VerticalAlignment="Center" Margin="0,0,8,4"/>
                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsLocked, Converter={StaticResource InverseBoolConverter}}"
                         Margin="0,0,16,4" Padding="4"/>

                <TextBlock Grid.Row="0" Grid.Column="2" Text="Locked:" VerticalAlignment="Center" Margin="0,0,8,4"/>
                <CheckBox Grid.Row="0" Grid.Column="3" IsChecked="{Binding IsLocked, Mode=OneWay}" IsEnabled="False"
                          VerticalAlignment="Center" Margin="0,0,0,4"/>

                <TextBlock Grid.Row="1" Grid.Column="0" Text="Description:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="3"
                         Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsLocked, Converter={StaticResource InverseBoolConverter}}"
                         Padding="4"/>
            </Grid>
        </GroupBox>

        <!-- Locked Warning Banner -->
        <Border Grid.Row="1" Background="#FFF3E0" BorderBrush="#FF9800" BorderThickness="1"
                Margin="4,0,4,4" Padding="8"
                Visibility="{Binding IsLocked, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="⚠️" FontSize="16" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Text="This definition is locked because recordings exist. Create a copy to edit."
                           VerticalAlignment="Center"/>
                <Button Content="Create Copy" Command="{Binding CreateCopyCommand}"
                        Margin="16,0,0,0" Padding="8,2"/>
            </StackPanel>
        </Border>

        <!-- Process Steps Grid -->
        <GroupBox Grid.Row="2" Header="Process Steps (Ablaufabschnitte)" Margin="4" Padding="4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Toolbar -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                    <Button Command="{Binding AddStepCommand}" Padding="8,4" Margin="0,0,4,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="➕" Margin="0,0,4,0"/>
                            <TextBlock Text="Add Step"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding RemoveStepCommand}" Padding="8,4" Margin="0,0,4,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="➖" Margin="0,0,4,0"/>
                            <TextBlock Text="Remove Step"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding SetDefaultStepCommand}" Padding="8,4" Margin="0,0,4,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="⭐" Margin="0,0,4,0"/>
                            <TextBlock Text="Set as Default"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Data Grid -->
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding ProcessSteps}"
                          SelectedItem="{Binding SelectedStep}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          IsReadOnly="{Binding IsLocked}"
                          SelectionMode="Single"
                          GridLinesVisibility="Horizontal"
                          AlternatingRowBackground="#F5F5F5"
                          HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Order #" Binding="{Binding OrderNumber}" Width="70"/>
                        <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" MinWidth="150"/>
                        <DataGridTextColumn Header="Product" Binding="{Binding ProductDescription}" Width="120"/>
                        <DataGridComboBoxColumn Header="Dimension Type"
                                                SelectedItemBinding="{Binding DimensionType}"
                                                Width="100">
                            <DataGridComboBoxColumn.ElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource" Value="{Binding DataContext.DimensionTypes, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                </Style>
                            </DataGridComboBoxColumn.ElementStyle>
                            <DataGridComboBoxColumn.EditingElementStyle>
                                <Style TargetType="ComboBox">
                                    <Setter Property="ItemsSource" Value="{Binding DataContext.DimensionTypes, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                </Style>
                            </DataGridComboBoxColumn.EditingElementStyle>
                        </DataGridComboBoxColumn>
                        <DataGridTextColumn Header="Unit" Binding="{Binding DimensionUnit}" Width="60"/>
                        <DataGridTextColumn Header="Default Value" Binding="{Binding DefaultDimensionValue}" Width="90"/>
                        <DataGridCheckBoxColumn Header="Default" Binding="{Binding IsDefaultStep}" Width="60"/>
                    </DataGrid.Columns>

                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsDefaultStep}" Value="True">
                                    <Setter Property="Background" Value="#E8F5E9"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </Grid>
        </GroupBox>

        <!-- Bottom Actions -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="4,0,4,4">
            <Button Command="{Binding StartRecordingCommand}"
                    Style="{StaticResource StartButtonStyle}"
                    Content="▶ Start Recording"
                    MinWidth="150"/>
        </StackPanel>
    </Grid>
</UserControl>
